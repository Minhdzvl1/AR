<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AR Interior Designer Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <style>
        body { margin: 0; overflow: hidden; font-family: sans-serif; background: #111; }
        
        /* Giao diện Overlay nằm trong AR */
        #ar-ui {
            position: absolute; bottom: 20px; width: 100%;
            display: none; flex-direction: column; align-items: center; gap: 10px;
            z-index: 1000;
        }

        .group { display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; background: rgba(0,0,0,0.6); padding: 12px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.2); }
        
        button {
            padding: 10px 15px; border-radius: 12px; border: none;
            background: white; color: #333; font-weight: bold; font-size: 13px;
            active { background: #ccc; }
        }

        .btn-add { background: #28a745; color: white; }
        .btn-ctrl { background: #007bff; color: white; min-width: 50px; font-size: 18px; }
        .label { color: white; font-size: 11px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; }
    </style>
</head>
<body>

    <div id="ar-ui">
        <div class="label">BƯỚC 1: THÊM ĐỒ VẬT</div>
        <div class="group">
            <button class="btn-add" onclick="createNewObject('ghe.glb')">Ghế</button>
            <button class="btn-add" onclick="createNewObject('ban.glb')">Bàn</button>
            <button class="btn-add" onclick="createNewObject('tivi.glb')">Tivi</button>
            <button class="btn-add" onclick="createNewObject('den.glb')">Đèn</button>
        </div>

        <div class="label">BƯỚC 2: CHỈNH VẬT VỪA ĐẶT (Nâng/Hạ - Tiến/Lùi)</div>
        <div class="group">
            <button class="btn-ctrl" onclick="moveLastObject('y', 0.05)">+</button>
            <button class="btn-ctrl" onclick="moveLastObject('y', -0.05)">-</button>
            <button class="btn-ctrl" onclick="moveLastObject('z', -0.05)">↑</button>
            <button class="btn-ctrl" onclick="moveLastObject('z', 0.05)">↓</button>
        </div>
    </div>

    <script>
        // Sử dụng biến toàn cục thay vì import
        let scene, camera, renderer, reticle;
        let loader = new THREE.GLTFLoader();
        let addedObjects = [];
        let hitTestSource = null;

        // Khởi tạo ngay lập tức
        init();

        function init() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.xr.enabled = true;
            document.body.appendChild(renderer.domElement);

            // Thêm ánh sáng
            const light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 1);
            scene.add(light);

            // Tạo nút AR thủ công để tránh lỗi thư viện
            if (navigator.xr) {
                const arButton = document.createElement('button');
                arButton.textContent = 'BẮT ĐẦU AR';
                arButton.style.position = 'absolute';
                arButton.style.bottom = '100px';
                arButton.style.left = '50%';
                arButton.style.transform = 'translateX(-50%)';
                arButton.style.padding = '15px 30px';
                arButton.style.fontSize = '18px';
                arButton.style.zIndex = '2000';
                document.body.appendChild(arButton);

                arButton.onclick = () => {
                    navigator.xr.requestSession('immersive-ar', {
                        requiredFeatures: ['hit-test'],
                        optionalFeatures: ['dom-overlay'],
                        domOverlay: { root: document.getElementById('ar-ui') }
                    }).then((session) => {
                        renderer.xr.setSession(session);
                        arButton.style.display = 'none';
                        document.getElementById('ar-ui').style.display = 'flex';
                    });
                };
            } else {
                alert("Thiết bị không hỗ trợ AR WebXR.");
            }

            // Tạo tâm ngắm (Reticle)
            reticle = new THREE.Mesh(
                new THREE.RingGeometry(0.1, 0.12, 32).rotateX(-Math.PI / 2),
                new THREE.MeshBasicMaterial({ color: 0x00ff00 })
            );
            reticle.matrixAutoUpdate = false;
            reticle.visible = false;
            scene.add(reticle);

            renderer.setAnimationLoop(render);
        }

        window.createNewObject = function(filename) {
            if (reticle.visible) {
                loader.load(filename, (gltf) => {
                    const model = gltf.scene;
                    model.position.setFromMatrixPosition(reticle.matrix);
                    scene.add(model);
                    addedObjects.push(model);
                }, undefined, (e) => alert("Không tìm thấy file 3D: " + filename));
            } else {
                alert("Hãy quét sàn để hiện vòng tròn xanh!");
            }
        };

        window.moveLastObject = function(axis, amount) {
            if (addedObjects.length > 0) {
                const lastObj = addedObjects[addedObjects.length - 1];
                if(axis === 'y') lastObj.position.y += amount;
                if(axis === 'z') {
                    // Di chuyển theo hướng camera đang nhìn
                    const dir = new THREE.Vector3(0, 0, amount);
                    dir.applyQuaternion(lastObj.quaternion);
                    lastObj.position.add(dir);
                }
            }
        };

        function render(timestamp, frame) {
            if (frame) {
                const session = renderer.xr.getSession();
                const referenceSpace = renderer.xr.getReferenceSpace();

                if (!hitTestSource) {
                    session.requestReferenceSpace('viewer').then((space) => {
                        session.requestHitTestSource({ space }).then((source) => {
                            hitTestSource = source;
                        });
                    });
                }

                if (hitTestSource) {
                    const hitTestResults = frame.getHitTestResults(hitTestSource);
                    if (hitTestResults.length > 0) {
                        const hit = hitTestResults[0];
                        reticle.visible = true;
                        reticle.matrix.fromArray(hit.getPose(referenceSpace).transform.matrix);
                    } else {
                        reticle.visible = false;
                    }
                }
            }
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>




